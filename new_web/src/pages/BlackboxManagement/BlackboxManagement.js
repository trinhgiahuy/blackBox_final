import * as React from 'react';
import { useEffect } from 'react';
import PropTypes from 'prop-types';
import { useDemoData } from '@mui/x-data-grid-generator';
import {
    DataGrid,
    GridToolbarContainer,
    GridToolbarExportContainer,
    GridCsvExportMenuItem,
    useGridApiContext,
    gridFilteredSortedRowIdsSelector,
    gridVisibleColumnFieldsSelector,
  } from '@mui/x-data-grid';
import MenuItem from '@mui/material/MenuItem';


const getJson = (apiRef) => {
    // Select rows and columns
    const filteredSortedRowIds = gridFilteredSortedRowIdsSelector(apiRef);
    const visibleColumnsField = gridVisibleColumnFieldsSelector(apiRef);
  
    // Format the data. Here we only keep the value
    const data = filteredSortedRowIds.map((id) => {
        const row = {};
        visibleColumnsField.forEach((field) => {
            row[field] = apiRef.current.getCellParams(id, field).value;
        });
        return row;
    });
  
    // Stringify with some indentation
    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify#parameters
    return JSON.stringify(data, null, 2);
};

const exportBlob = (blob, filename) => {
    // Save the blob in a json file
    const url = URL.createObjectURL(blob);
  
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
  
    setTimeout(() => {
        URL.revokeObjectURL(url);
    });
};



const JsonExportMenuItem = (props) => {
    const apiRef = useGridApiContext();
    
    return (
        <MenuItem
            onClick={() => {
            const jsonString = getJson(apiRef);
            const blob = new Blob([jsonString], {
                type: 'text/json',
            });
    
            exportBlob(blob, 'DataGrid_demo.json');
    
            // Hide the export menu after the export
            // hideMenu?.();
            }}
        >
            Export JSON
        </MenuItem>
    );
};

JsonExportMenuItem.propTypes = {
    hideMenu: PropTypes.func,
};
  
const csvOptions = { delimiter: ';' };

const CustomExportButton = (props) => (
    <GridToolbarExportContainer {...props}>
        <GridCsvExportMenuItem options={csvOptions} />
        <JsonExportMenuItem />
    </GridToolbarExportContainer>
);

const CustomToolbar = (props) => (
    <GridToolbarContainer {...props}>
        <CustomExportButton />
    </GridToolbarContainer>
);

const BlackboxManagement = () => {
    const { data, loading } = useDemoData({
        dataSet: 'Commodity',
        rowLength: 4,
        maxColumns: 6,
    });

    useEffect(() => {
        fetch("http://localhost:9000/management")
        .catch(err => err);
    })

    return (
        <div style={{ height: 300, width: '100%' }}>
            <DataGrid
                {...data}
                loading={loading}
                components={{ Toolbar: CustomToolbar }}
            />
        </div>
    );
}

export default BlackboxManagement;

